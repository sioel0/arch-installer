---
# tasks file for housekeeping
- name: Remove archinstall logs
  become: True
  ansible.builtin.file:
    path: /var/log/archinstall
    state: absent

- name: Enable services
  become: True
  systemd:
    enabled: True
    name: "{{ item }}"
  with_items:
    - ly
    - libvirtd
    - docker
    - udisks2

- name: Make zathura the default pdfviewer
  shell:
    cmd: xdg-mime default org.pwmt.zathura.desktop application/pdf

- name: Install oh-my-zsh
  shell:
    cmd: sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" -s -- -y

- name: Install zsh-autosuggestions
  git:
    repo: https://github.com/zsh-users/zsh-autosuggestions
    dest: ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions
    clone: yes
    update: yes

- name: Install zsh-syntax-highlighting
  git:
    repo: https://github.com/zsh-users/zsh-syntax-highlighting
    dest: ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
    clone: yes
    update: yes

- name: Install powerlevel10k theme
  git:
    repo: https://github.com/romkatv/powerlevel10k
    dest: ~/.oh-my-zsh/custom/themes/powerlevel10k
    clone: yes
    update: yes

- name: Set zsh as default user shell
  become: True
  user:
    name: "{{ lookup('env', 'USER')}}"
    shell: /usr/bin/zsh

- name: Install dotfiles
  shell:
    cmd: |
      cd dots
      ./install.sh

- name: Create polkit repo
  file:
    path: /etc/polkit1/rules.d
    state: directory

- name: Polkit rule for poweroff and reboot
  become: True
  copy:
    dest: /etc/polkit1/rules.d/60-poweroff_reboot.rules
    content: |
      polkit.addRule(function(action, subject) {
        if ((action.id == "org.freedesktop.login1.reboot" ||
             action.id == "org.freedesktop.login1.reboot-multiple-sessions" ||
             action.id == "org.freedesktop.login1.power-off" ||
             action.id == "org.freedesktop.login1.power-off-multiple-sessions") &&
             subject.isInGroup("wheel")) {
               return polkit.Result.YES;
             }
      });
